var $modal = $("#modal-url");var $modalConfirm = $("#modal-remove-confirm");var URL;URL = {    addURL: function () {        var that = this;        $('.btn-add-url').click(function (e) {            e.preventDefault();            that.formReset();            $modal.find("form").attr('data-action', 'add');            $modal.find('.modal-title').html("Création URL");            var instanceId = $(this).data("id");            if ($modal && instanceId) {                $modal.find("select[name='instance']").val(instanceId);                if (instanceId == 1) {                    $("#form-host").addClass("hide");                } else if ($("#form-host").hasClass("hide")) {                    $("#form-host").removeClass("hide");                }                $modal.modal();            }        });    },    editURL: function ($url) {        var that = this;        $modal.modal();        $modal.find('.modal-title').html("Édition URL");        var $form = $modal.find("form");        $form.attr('data-action', 'edit');        $form.attr('data-url', $url.data("url"));        $form.attr('data-instance-old', $url.data("instance"));        that.formReset();        $form.find("input[name='title']").val($url.data("title"));        $form.find("select[name='instance']").val($url.data("instance"));        $form.find("input[name='url']").val($url.find("td.url").text());        $form.find("input[name='host']").val($url.find("td.host").text());        $form.find("input[name='active']").prop("checked", $url.find("input[name='active']").is(':checked')).change();        var noHost = $url.data("no_host");        if (noHost == 1) {            $("#form-host").addClass("hide").fadeOut("slow");        } else {            $("#form-host").removeClass("hide").fadeIn("slow");        }        $form.find("textarea[name='description']").val($url.data("description"));    },    instanceChange: function () {        $modal.find("select[name='instance']").change(function () {            if ($modal.find("form select[name='instance'] option:selected").data("no_host") == 1) //no host            {                $("#form-host").addClass("hide").fadeOut("slow");            } else if ($("#form-host").hasClass("hide")) {                $("#form-host").removeClass("hide").fadeIn("slow");            }        });    },    formReset: function () {        var $form = $modal.find("form");        if ($form) {            $form.find("input[name='title']").val("");            $form.find("input[name='url']").val("");            $form.find("input[name='host']").val("");            $form.find("textarea[name='description']").val("");            $form.find("input[name='active']").prop("checked", true);        }    },    submit: function () {        var that = this;        // var idURL = 0;        $modal.find("form").submit(function (e) {            e.preventDefault();            var $form = $modal.find("form");            var action = $form.attr('data-action');            console.log(action);            var instanceId = $form.find("select[name='instance']").val();            var title = $form.find("input[name='title']").val();            var url = $form.find("input[name='url']").val();            var noHost = $form.find("select[name='instance'] option:selected").data("no_host");            if (noHost == 1) {                var host = null;            } else {                var host = $form.find("input[name='host']").val();            }            var active = $form.find("input[name='active']").is(':checked');            var description = $form.find("textarea[name='description']").val();            var params = {                id: 0,                title: title,                instance: instanceId,                url: url,                host: host,                noHost: noHost,                active: active,                description: description,            }            if (action == "add") {                if (instanceId && title && url) {                    var href = Routing.generate('instance_new_ajax');                    console.log(params);                    that.ajaxAction(href, params, action, "add");                } else {                    console.log("Erreur parameters !!");                }                $modal.modal('hide');                that.formReset();            } else if (action == "edit") {                params.id = $form.attr('data-url');                var instanceIdOld = $form.attr('data-instance-old');                var href = Routing.generate('instance_edit_ajax');                that.formReset();                if (instanceId && title && url && params.id && null !== params.id) {                    action = instanceIdOld != params.instance ? "add" : "edit";                    if (action == "add") {                        $('#line-url-' + params.id).remove();                    }                    that.ajaxAction(href, params, action, "edit");                    $modal.modal('hide');                } else {                    console.log("Erreur parameters !!");                }            }        });    },    ajaxAction: function (href, params, action, origin) {        var that = this;        console.log(params);        $.getJSON(href, params).done(function (data) {            if (action == "add" && data.result == "success" && data.id) {                var idURL = data.id;                var line = $('<tr id="line-url-' + idURL + '" ' +                    'data-instance="' + params.instance + '"' +                    'data-title="' + params.title + '"' +                    ' data-url="' + params.url + '" ' +                    'data-no_host="' + ((params.host == null) ? 1 : 0) + '"' +                    'data-description="' + params.description + '"></tr>')                var tableID = $('#table-instance-' + params.instance);                var title = params.title.length > 20 ? params.title.substring(0, 20) + " ..." : params.title;                line.append('<td class="title">' + title + '</td>');                line.append('<td class="url">' + params.url + '</td>');                if (params.host != null && params.noHost != 1) {                    line.append('<td class="host">' + params.host + '</td>');                }                var edit = $('<button class="btn btn-default btn-xs"><i class="fa fa-edit"> Edit</i></button>');                var remove = $('<button class="btn btn-danger btn-xs"><i class="fa fa-trash"> Supp</i></button>');                var checkbox = $('<input name="active" ' +                    ' id="btn_enable" data-size="mini" ' +                    ' data-notify-id="' + params.id + '"' +                    ' data-notify-name="' + params.title + '" ' +                    ' data-on="Activer" data-off="Désactiver" data-onstyle = "success" data-offstyle = "warning"' +                    ' data-toggle="toggle" type="checkbox" >');                checkbox.prop('checked', params.active)                checkbox.click(function (e) {                    e.preventDefault();                    checkbox.find("input[name='active']").prop("checked", $(this).is(':checked')).change();                    //that.activeAction($("#line-url-" + idURL));                });                edit.click(function (e) {                    e.preventDefault();                    that.editURL($("#line-url-" + idURL))                });                remove.click(function (e) {                    e.preventDefault();                    var tr = $(this).closest("tr");                    that.confirmAction($("#line-url-" + idURL));                });                var options = $('<td class="text-center"></td>').append(checkbox).append(" ").append(edit).append(" ").append(remove);                line.append(options);                tableID.find('tbody').append(line);                checkbox.bootstrapToggle();                if (origin == "add") {                    var message = "L'url a été bien ajoutée."                } else if (origin == "edit") {                    var message = "Les modifications ont été bien enregistrées."                }                that.notification({                    icon: 'fa fa-check',                    title: "",                    message: message,                    type: "success",                });            } else if (action == "edit" && data.result == "success" && data.id) {                var idURL = data.id;                var $line = $('#line-url-' + idURL);                if ($line) {                    $line.attr('data-instance', params.instance);                    $line.attr('data-url', params.url);                    $line.attr('data-title', params.title);                    $line.attr('data-description', params.description);                    $line.find("input[name='active']").prop("checked", params.active).change();                    $line.find('.title').html(params.title);                    $line.find('.url').html(params.url);                    // if (params.host != null && params.noHost != 1) {                    //     $line.append('<td class="host">' + params.host + '</td>');                    // } else {                    $line.find('.host').html(params.host);                    // }                    that.notification({                        icon: 'fa fa-check',                        title: "",                        message: "Les modifications ont été bien enregistrées.",                        type: "success",                    });                }            } else {                console.log(data);            }        });    },    deleteAction: function ($url) {        var that = this;        console.log($url);        var href = Routing.generate("instance_remove_ajax");        var id = $url.data("url");        var name = $url.data('title');        console.log(name);        if (id) {            $.getJSON(href, {id: id}).done(function (data) {                if (data.result == "success" && data.remove) {                    that.notification({                        icon: 'fa fa-check',                        title: "L'URL " + name,                        message: "a été supprimée.",                        type: "success",                    });                    $url.remove();                } else if (data.result == "success" && !data.remove) {                    that.notification({                        icon: 'fa fa-check',                        title: "L'URL " + name,                        message: "n'a pas été supprimée.",                        type: "danger",                    });                } else {                    console.log(data);                }                $modalConfirm.modal('hide');            });        } else {            console.log("ID not found");        }    },    confirmAction: function ($url) {        var that = this;        console.log($url);        $modalConfirm.modal();        $modalConfirm.find(".url").html('"' + $url.data('title') + '"');        $('.btn-ok').click(function (e) {            e.preventDefault();            that.deleteAction($url)        });    },    activeAction: function ($url) {        var that = this;        var href = Routing.generate("instance_active_ajax");        var name = $url.data("title")        // name = name.length > 20 ? $url.data("title").substring(0, 20) + " ..." : $url.data("title")        var params = {            id: $url.data("url"),            active: $url.find("input[name='active']").is(':checked')        };        if (params) {            $.getJSON(href, params).done(function (data) {                if (data.result == "success") {                    if (data.active) {                        that.notification({                            icon: 'fa fa-check',                            title: "L'URL " + name,                            message: "a été activée.",                            type: "success",                        });                    } else {                        that.notification({                            icon: 'fa fa-check',                            title: "L'URL " + name,                            message: "a été désactivée.",                            type: "warning",                        });                    }                } else {                    that.notification({                        icon: 'fa fa-warning',                        title: "L'URL " + name,                        message: "a été désactivée.",                        type: "danger",                    });                }            });        } else {            console.log("ID not found");        }    },    notification: function (result) {        $.notify({            icon: result.icon,            title: result.title,            message: result.message,        }, {            // settings            element: 'body',            position: null,            type: result.type,            allow_dismiss: true,            newest_on_top: false,            showProgressbar: false,            placement: {                from: "top",                align: "right"            },            offset: 20,            spacing: 10,            z_index: 1031,            delay: 2000,            timer: 500,            url_target: '_blank',            mouse_over: null,            animate: {                enter: 'animated fadeInDown',                exit: 'animated fadeOutUp'            },            onShow: null,            onShown: null,            onClose: null,            onClosed: null,            icon_type: 'class',            template: '<div data-notify="container" class="col-xs-11 col-sm-3 alert alert-{0}" role="alert">' +            '<button type="button" aria-hidden="true" class="close" data-notify="dismiss">×</button>' +            '<span data-notify="icon"></span> ' +            '<b><span data-notify="title">{1}</span></b> ' +            '<span data-notify="message">{2}</span>' +            '<div class="progress" data-notify="progressbar">' +            '<div class="progress-bar progress-bar-{0}" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"></div>' +            '</div>' +            '</div>'        });    },    init: function () {        $(".btn").removeClass("hide");        this.addURL();        this.instanceChange();        this.submit();    }};$(function () {    URL.init();    $("tr").find('input[data-toggle="toggle"]').change(function () {        var $line = $("#line-url-" + $(this).closest("tr").data("url"));        if ($line) {            URL.activeAction($line);        }    });    $('.btn-delete').click(function (e) {        e.preventDefault();        var $line = $("#line-url-" + $(this).closest("tr").data("url"));        if ($line) {            URL.confirmAction($line);        }    });    $('.btn-edit').click(function (e) {        var $line = $("#line-url-" + $(this).closest("tr").data("url"));        e.preventDefault();        if ($line)            URL.editURL($line)    });});